<style>body {background: white}</style><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Untitled</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="CoolUtils HTML exporter" />
<style type="text/css">
<!--
body { color: #000000; background-color: #FFFFFF; }
.python1-classname { color: #000080; font-weight: bold; }
.python1-comment { color: #808080; font-style: italic; }
.python1-commentedcode { color: #C0C0C0; font-style: italic; }
.python1-documentation { color: #CC00FF; }
.python1-float { color: #008080; }
.python1-functionname { color: #008080; font-weight: bold; }
.python1-hexadecimal { color: #008080; }
.python1-identifier { color: #000000; }
.python1-matchingbrace { color: #0000FF; font-weight: bold; }
.python1-multi-linestring { color: #808000; }
.python1-nonreservedkeyword { color: #000080; }
.python1-number { color: #008080; }
.python1-octal { color: #008080; }
.python1-reservedword { font-weight: bold; }
.python1-space { color: #C0C0C0; }
.python1-string { color: #808000; }
.python1-symbol { color: #800000; }
.python1-syntaxerror { color: #FF0000; }
.python1-systemfunctionsandvariables { font-weight: bold; }
.python1-unbalancedbrace { color: #FFFF00; }
-->
</style>
</head>
<body>
<!--StartFragment--><pre><code><span class="python1-comment"># -*- coding: utf-8 -*-
</span><span class="python1-documentation">&quot;&quot;&quot;EVIDENCIA A00839234

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ll8WaJfqRwmHtv5h97Sr4mTEpXOzZXoL
&quot;&quot;&quot;

</span><span class="python1-comment"># -*- coding: utf-8 -*-
</span><span class="python1-documentation">&quot;&quot;&quot;EVIDENCIA A00839234

This script analyzes a portfolio of stocks (XOM, PG, AAPL, PFE) from HowTheMarketWorks
using time series modeling, stationarity tests, cointegration analysis, forecasting,
and portfolio performance evaluation as part of the &quot;Automation of Algorithms in
Capital Analyst Portfolios&quot; project.

Automatically generated by Colab.
Original file is located at
    https://colab.research.google.com/drive/1ll8WaJfqRwmHtv5h97Sr4mTEpXOzZXoL
&quot;&quot;&quot;

</span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">yfinance</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">yf
</span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">pandas</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">pd
</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">statsmodels</span><span class="python1-symbol">.</span><span class="python1-identifier">tsa</span><span class="python1-symbol">.</span><span class="python1-identifier">stattools</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">adfuller</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">coint
</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">statsmodels</span><span class="python1-symbol">.</span><span class="python1-identifier">tsa</span><span class="python1-symbol">.</span><span class="python1-identifier">arima</span><span class="python1-symbol">.</span><span class="python1-identifier">model</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">ARIMA
</span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">matplotlib</span><span class="python1-symbol">.</span><span class="python1-identifier">pyplot</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">plt
</span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">matplotlib</span><span class="python1-symbol">.</span><span class="python1-identifier">dates</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">mdates
</span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">numpy</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">np

</span><span class="python1-comment"># Ensure plots are displayed inline (commented for .py compatibility, use in Colab)
# %matplotlib inline

</span><span class="python1-reservedword">def</span><span class="python1-space"> </span><span class="python1-functionname">download_and_clean_data</span><span class="python1-symbol">(</span><span class="python1-identifier">tickers</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">start_date</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">end_date</span><span class="python1-symbol">):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Download historical stock data and calculate daily returns.

    Args:
        tickers (list): List of stock tickers.
        start_date (str): Start date for data (YYYY-MM-DD).
        end_date (str): End date for data (YYYY-MM-DD).

    Returns:
        pandas.DataFrame: DataFrame of daily returns.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-reservedword">try</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-identifier">data</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">yf</span><span class="python1-symbol">.</span><span class="python1-identifier">download</span><span class="python1-symbol">(</span><span class="python1-identifier">tickers</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">start</span><span class="python1-symbol">=</span><span class="python1-identifier">start_date</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">end</span><span class="python1-symbol">=</span><span class="python1-identifier">end_date</span><span class="python1-symbol">)[</span><span class="python1-string">'Close'</span><span class="python1-symbol">]
</span><span class="python1-space">        </span><span class="python1-identifier">returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">data</span><span class="python1-symbol">.</span><span class="python1-identifier">pct_change</span><span class="python1-symbol">().</span><span class="python1-identifier">dropna</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-identifier">returns</span><span class="python1-symbol">.</span><span class="python1-identifier">to_csv</span><span class="python1-symbol">(</span><span class="python1-string">'portfolio_returns.csv'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">return</span><span class="python1-space"> </span><span class="python1-identifier">returns
</span><span class="python1-space">    </span><span class="python1-reservedword">except</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">Exception</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">e</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Error downloading data: {e}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">raise

</span><span class="python1-comment"># Define the tickers from your HowTheMarketWorks portfolio
</span><span class="python1-identifier">tickers</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">[</span><span class="python1-string">'XOM'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PG'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'AAPL'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PFE'</span><span class="python1-symbol">]

</span><span class="python1-comment"># Download historical data (2 years up to June 14, 2025, current date)
</span><span class="python1-identifier">returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">download_and_clean_data</span><span class="python1-symbol">(</span><span class="python1-identifier">tickers</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">start_date</span><span class="python1-symbol">=</span><span class="python1-string">'2023-06-14'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">end_date</span><span class="python1-symbol">=</span><span class="python1-string">'2025-06-14'</span><span class="python1-symbol">)

</span><span class="python1-comment"># Display the first few rows and summary statistics
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Cleaned Returns Data:&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">.</span><span class="python1-identifier">head</span><span class="python1-symbol">())
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;\nSummary Statistics:&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">.</span><span class="python1-identifier">describe</span><span class="python1-symbol">())

</span><span class="python1-reservedword">def</span><span class="python1-space"> </span><span class="python1-functionname">adf_test</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock_name</span><span class="python1-symbol">):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Perform Augmented Dickey-Fuller test for stationarity.

    Args:
        series (pandas.Series): Time series to test.
        stock_name (str): Name of the stock.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-identifier">result</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">adfuller</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nADF Test Results for {stock_name}:&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;ADF Statistic: {result[0]:.2f}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;p-value: {result[1]:.4f}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Critical Values:&quot;</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-symbol">{</span><span class="python1-identifier">k</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-identifier">v</span><span class="python1-space"> </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">k</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">v</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">result</span><span class="python1-symbol">[</span><span class="python1-number">4</span><span class="python1-symbol">].</span><span class="python1-identifier">items</span><span class="python1-symbol">()})
</span><span class="python1-space">    </span><span class="python1-reservedword">if</span><span class="python1-space"> </span><span class="python1-identifier">result</span><span class="python1-symbol">[</span><span class="python1-number">1</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">&lt;</span><span class="python1-space"> </span><span class="python1-float">0.05</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Reject H0 - Series is stationary.&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">else</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Fail to reject H0 - Series is non-stationary.&quot;</span><span class="python1-symbol">)

</span><span class="python1-comment"># Apply ADF test to each stock's returns
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-identifier">adf_test</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-symbol">)

</span><span class="python1-reservedword">def</span><span class="python1-space"> </span><span class="python1-functionname">fit_arima</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock_name</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">order</span><span class="python1-symbol">=(</span><span class="python1-number">1</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">0</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">1</span><span class="python1-symbol">)):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Fit an ARIMA model to the time series.

    Args:
        series (pandas.Series): Time series to model.
        stock_name (str): Name of the stock.
        order (tuple): ARIMA order (p, d, q).

    Returns:
        statsmodels.tsa.arima.model.ARIMAResults: Fitted model results.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-reservedword">try</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-identifier">model</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">ARIMA</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">order</span><span class="python1-symbol">=</span><span class="python1-identifier">order</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">model_fit</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">model</span><span class="python1-symbol">.</span><span class="python1-identifier">fit</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nARIMA({order[0]},{order[1]},{order[2]}) Summary for {stock_name}:&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">model_fit</span><span class="python1-symbol">.</span><span class="python1-identifier">summary</span><span class="python1-symbol">())
</span><span class="python1-space">        </span><span class="python1-reservedword">return</span><span class="python1-space"> </span><span class="python1-identifier">model_fit
</span><span class="python1-space">    </span><span class="python1-reservedword">except</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">Exception</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">e</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Error fitting ARIMA for {stock_name}: {e}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">raise

</span><span class="python1-comment"># Fit ARIMA models using best orders
</span><span class="python1-identifier">models</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{}
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-identifier">models</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">fit_arima</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">order</span><span class="python1-symbol">=</span><span class="python1-identifier">best_orders</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">])

</span><span class="python1-comment"># Plot residuals for one stock (e.g., XOM) to check model fit
</span><span class="python1-identifier">residuals</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">models</span><span class="python1-symbol">[</span><span class="python1-string">'XOM'</span><span class="python1-symbol">].</span><span class="python1-identifier">resid
plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">residuals</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-string">'Residuals of ARIMA(1,0,1) for XOM'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-comment"># Fetch original data for cointegration (assuming data is still in scope)
</span><span class="python1-identifier">data</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">yf</span><span class="python1-symbol">.</span><span class="python1-identifier">download</span><span class="python1-symbol">(</span><span class="python1-identifier">tickers</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">start</span><span class="python1-symbol">=</span><span class="python1-string">'2023-06-14'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">end</span><span class="python1-symbol">=</span><span class="python1-string">'2025-06-14'</span><span class="python1-symbol">)[</span><span class="python1-string">'Close'</span><span class="python1-symbol">]

</span><span class="python1-comment"># Test cointegration between pairs
</span><span class="python1-identifier">pairs</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">[(</span><span class="python1-string">'XOM'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PG'</span><span class="python1-symbol">),</span><span class="python1-space"> </span><span class="python1-symbol">(</span><span class="python1-string">'AAPL'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PFE'</span><span class="python1-symbol">)]
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">stock1</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock2</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">pairs</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-identifier">score</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">p_value</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">_</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">coint</span><span class="python1-symbol">(</span><span class="python1-identifier">data</span><span class="python1-symbol">[</span><span class="python1-identifier">stock1</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">data</span><span class="python1-symbol">[</span><span class="python1-identifier">stock2</span><span class="python1-symbol">])
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nCointegration Test between {stock1} and {stock2}:&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;p-value: {p_value:.4f}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">if</span><span class="python1-space"> </span><span class="python1-identifier">p_value</span><span class="python1-space"> </span><span class="python1-symbol">&lt;</span><span class="python1-space"> </span><span class="python1-float">0.05</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Reject H0 - Cointegration exists.&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">else</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Fail to reject H0 - No cointegration.&quot;</span><span class="python1-symbol">)

</span><span class="python1-reservedword">def</span><span class="python1-space"> </span><span class="python1-functionname">forecast_and_plot</span><span class="python1-symbol">(</span><span class="python1-identifier">model</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock_name</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">steps</span><span class="python1-symbol">):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Generate and plot forecasts for a given stock.

    Args:
        model (statsmodels.tsa.arima.model.ARIMAResults): Fitted ARIMA model.
        stock_name (str): Name of the stock.
        steps (int): Number of forecast steps.

    Returns:
        pandas.Series: Forecast values.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-reservedword">try</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-identifier">forecast</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">model</span><span class="python1-symbol">.</span><span class="python1-identifier">forecast</span><span class="python1-symbol">(</span><span class="python1-identifier">steps</span><span class="python1-symbol">=</span><span class="python1-identifier">steps</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">forecast</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Forecast'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">stock_name</span><span class="python1-symbol">][-</span><span class="python1-identifier">steps</span><span class="python1-symbol">:],</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Actual'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">color</span><span class="python1-symbol">=</span><span class="python1-string">'red'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'{steps}-Day Forecast for {stock_name}'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">legend</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-reservedword">return</span><span class="python1-space"> </span><span class="python1-identifier">forecast
</span><span class="python1-space">    </span><span class="python1-reservedword">except</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">Exception</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">e</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Error forecasting for {stock_name}: {e}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">raise

def</span><span class="python1-space"> </span><span class="python1-functionname">forecast_and_plot</span><span class="python1-symbol">(</span><span class="python1-identifier">model</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock_name</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">steps</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">actual_series</span><span class="python1-symbol">):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Generate and plot forecasts for a given stock, and calculate deviations.

    Args:
        model (statsmodels.tsa.arima.model.ARIMAResults): Fitted ARIMA model.
        stock_name (str): Name of the stock.
        steps (int): Number of forecast steps.
        actual_series (pandas.Series): Actual series for comparison.

    Returns:
        pandas.Series: Forecast values.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-reservedword">try</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-identifier">forecast</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">model</span><span class="python1-symbol">.</span><span class="python1-identifier">forecast</span><span class="python1-symbol">(</span><span class="python1-identifier">steps</span><span class="python1-symbol">=</span><span class="python1-identifier">steps</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-comment"># Get the last 'steps' actual values for comparison
</span><span class="python1-space">        </span><span class="python1-identifier">actual</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">actual_series</span><span class="python1-symbol">[-</span><span class="python1-identifier">steps</span><span class="python1-symbol">:]
</span><span class="python1-space">        </span><span class="python1-comment"># Calculate percentage deviation
</span><span class="python1-space">        </span><span class="python1-identifier">deviation</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">abs</span><span class="python1-symbol">((</span><span class="python1-identifier">forecast</span><span class="python1-space"> </span><span class="python1-symbol">-</span><span class="python1-space"> </span><span class="python1-identifier">actual</span><span class="python1-symbol">)</span><span class="python1-space"> </span><span class="python1-symbol">/</span><span class="python1-space"> </span><span class="python1-identifier">actual</span><span class="python1-symbol">)</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-number">100
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nDeviation for {stock_name} (Percentage):&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">deviation</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">if</span><span class="python1-space"> </span><span class="python1-symbol">(</span><span class="python1-identifier">deviation</span><span class="python1-space"> </span><span class="python1-symbol">&gt;</span><span class="python1-space"> </span><span class="python1-number">10</span><span class="python1-symbol">).</span><span class="python1-identifier">any</span><span class="python1-symbol">():
</span><span class="python1-space">            </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Warning: {stock_name} forecast deviates &gt;10%. Possible reasons: high volatility or model misspecification.&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">else</span><span class="python1-symbol">:
</span><span class="python1-space">            </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;{stock_name} forecast is within 10% of actual values.&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-comment"># Plot forecast vs actual
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">forecast</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">forecast</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Forecast'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">color</span><span class="python1-symbol">=</span><span class="python1-string">'blue'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">actual</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">actual</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Actual'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">color</span><span class="python1-symbol">=</span><span class="python1-string">'red'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'{steps}-Day Forecast vs Actual for {stock_name}'</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">legend</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_formatter</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">DateFormatter</span><span class="python1-symbol">(</span><span class="python1-string">'%Y-%m-%d'</span><span class="python1-symbol">))
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_locator</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">DayLocator</span><span class="python1-symbol">())
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gcf</span><span class="python1-symbol">().</span><span class="python1-identifier">autofmt_xdate</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">savefig</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'forecast_{stock_name}.png'</span><span class="python1-symbol">)</span><span class="python1-space">  </span><span class="python1-comment"># Save plot for report
</span><span class="python1-space">        </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()
</span><span class="python1-space">        </span><span class="python1-reservedword">return</span><span class="python1-space"> </span><span class="python1-identifier">forecast
</span><span class="python1-space">    </span><span class="python1-reservedword">except</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">Exception</span><span class="python1-space"> </span><span class="python1-reservedword">as</span><span class="python1-space"> </span><span class="python1-identifier">e</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Error forecasting for {stock_name}: {e}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">        </span><span class="python1-reservedword">raise

</span><span class="python1-comment"># Generate 10-day forecasts for each stock
</span><span class="python1-identifier">steps</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-number">10
</span><span class="python1-identifier">forecasts</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{}
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-identifier">forecasts</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">forecast_and_plot</span><span class="python1-symbol">(</span><span class="python1-identifier">models</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">steps</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">])

</span><span class="python1-comment"># Print forecast values
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;\nForecasts (10 Days):&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">forecast</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">forecasts</span><span class="python1-symbol">.</span><span class="python1-identifier">items</span><span class="python1-symbol">():
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;{ticker}: {forecast.values}&quot;</span><span class="python1-symbol">)
</span><span class="python1-comment"># Define portfolio weights based on HowTheMarketWorks allocation
</span><span class="python1-identifier">weights</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{</span><span class="python1-string">'XOM'</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-float">0.2607</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PG'</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-float">0.2635</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'AAPL'</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-float">0.2478</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'PFE'</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-float">0.2279</span><span class="python1-symbol">}

</span><span class="python1-comment"># Calculate portfolio returns
</span><span class="python1-identifier">portfolio_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">sum</span><span class="python1-symbol">(</span><span class="python1-identifier">weights</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">)

</span><span class="python1-comment"># Cumulative portfolio returns
</span><span class="python1-identifier">cumulative_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">(</span><span class="python1-number">1</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_returns</span><span class="python1-symbol">).</span><span class="python1-identifier">cumprod</span><span class="python1-symbol">()

</span><span class="python1-comment"># Plot cumulative returns
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-string">'Cumulative Portfolio Returns'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_formatter</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">DateFormatter</span><span class="python1-symbol">(</span><span class="python1-string">'%Y-%m-%d'</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_locator</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">MonthLocator</span><span class="python1-symbol">())
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gcf</span><span class="python1-symbol">().</span><span class="python1-identifier">autofmt_xdate</span><span class="python1-symbol">()
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-comment"># Summary statistics
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;\nPortfolio Return Statistics:&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">portfolio_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">describe</span><span class="python1-symbol">())

</span><span class="python1-comment"># Simple strategy: Buy if forecast &gt; 0, Sell if &lt; 0
</span><span class="python1-identifier">signals</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{</span><span class="python1-identifier">ticker</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-symbol">(</span><span class="python1-identifier">forecasts</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">&gt;</span><span class="python1-space"> </span><span class="python1-number">0</span><span class="python1-symbol">).</span><span class="python1-identifier">astype</span><span class="python1-symbol">(</span><span class="python1-nonreservedkeyword">int</span><span class="python1-symbol">)</span><span class="python1-space"> </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">}
</span><span class="python1-identifier">strategy_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{</span><span class="python1-identifier">ticker</span><span class="python1-symbol">:</span><span class="python1-space"> </span><span class="python1-identifier">signals</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">].</span><span class="python1-identifier">shift</span><span class="python1-symbol">(</span><span class="python1-number">1</span><span class="python1-symbol">)</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">}

</span><span class="python1-comment"># Portfolio strategy returns
</span><span class="python1-identifier">portfolio_strategy_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">sum</span><span class="python1-symbol">(</span><span class="python1-identifier">weights</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-identifier">strategy_returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">)

</span><span class="python1-comment"># Cumulative strategy returns
</span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">(</span><span class="python1-number">1</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_strategy_returns</span><span class="python1-symbol">).</span><span class="python1-identifier">cumprod</span><span class="python1-symbol">()

</span><span class="python1-comment"># Align indices: Reindex cumulative_strategy_returns to match cumulative_returns' DatetimeIndex
</span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">reindex</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">).</span><span class="python1-identifier">fillna</span><span class="python1-symbol">(</span><span class="python1-number">0</span><span class="python1-symbol">)

</span><span class="python1-comment"># Plot strategy vs passive returns
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Passive Returns'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">color</span><span class="python1-symbol">=</span><span class="python1-string">'red'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">plot</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">index</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">label</span><span class="python1-symbol">=</span><span class="python1-string">'Strategy Returns'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-string">'Cumulative Returns: Strategy vs Passive'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">legend</span><span class="python1-symbol">()
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_formatter</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">DateFormatter</span><span class="python1-symbol">(</span><span class="python1-string">'%Y-%m-%d'</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">().</span><span class="python1-identifier">xaxis</span><span class="python1-symbol">.</span><span class="python1-identifier">set_major_locator</span><span class="python1-symbol">(</span><span class="python1-identifier">mdates</span><span class="python1-symbol">.</span><span class="python1-identifier">MonthLocator</span><span class="python1-symbol">())
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gcf</span><span class="python1-symbol">().</span><span class="python1-identifier">autofmt_xdate</span><span class="python1-symbol">()
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-comment"># Debug print to verify data
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Reindexed Cumulative Strategy Returns Head:&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_strategy_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">head</span><span class="python1-symbol">())
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Cumulative Returns Head:&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">cumulative_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">head</span><span class="python1-symbol">())

</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">statsmodels</span><span class="python1-symbol">.</span><span class="python1-identifier">stats</span><span class="python1-symbol">.</span><span class="python1-identifier">diagnostic</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">acorr_ljungbox
</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">statsmodels</span><span class="python1-symbol">.</span><span class="python1-identifier">graphics</span><span class="python1-symbol">.</span><span class="python1-identifier">tsaplots</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">plot_acf</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">plot_pacf

</span><span class="python1-comment"># Residual diagnostics for all stocks
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nResidual Diagnostics for {ticker}:&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">residuals</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">models</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">].</span><span class="python1-identifier">resid
</span><span class="python1-space">    </span><span class="python1-comment"># Ljung-Box test for white noise (lag=10)
</span><span class="python1-space">    </span><span class="python1-identifier">lb_test</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">acorr_ljungbox</span><span class="python1-symbol">(</span><span class="python1-identifier">residuals</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">lags</span><span class="python1-symbol">=[</span><span class="python1-number">10</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">return_df</span><span class="python1-symbol">=</span><span class="python1-nonreservedkeyword">True</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Ljung-Box Test (lag=10): p-value = {lb_test['lb_pvalue'].iloc[0]:.4f}&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">if</span><span class="python1-space"> </span><span class="python1-identifier">lb_test</span><span class="python1-symbol">[</span><span class="python1-string">'lb_pvalue'</span><span class="python1-symbol">].</span><span class="python1-identifier">iloc</span><span class="python1-symbol">[</span><span class="python1-number">0</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">&gt;</span><span class="python1-space"> </span><span class="python1-float">0.05</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Residuals are white noise (no significant autocorrelation).&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">else</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;Conclusion: Residuals show autocorrelation (model may need adjustment).&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-comment"># ACF and PACF plots
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">4</span><span class="python1-symbol">))
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">subplot</span><span class="python1-symbol">(</span><span class="python1-number">121</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plot_acf</span><span class="python1-symbol">(</span><span class="python1-identifier">residuals</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">lags</span><span class="python1-symbol">=</span><span class="python1-number">20</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">ax</span><span class="python1-symbol">=</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">())
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'ACF of Residuals ({ticker})'</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">subplot</span><span class="python1-symbol">(</span><span class="python1-number">122</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plot_pacf</span><span class="python1-symbol">(</span><span class="python1-identifier">residuals</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">lags</span><span class="python1-symbol">=</span><span class="python1-number">20</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">ax</span><span class="python1-symbol">=</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">())
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'PACF of Residuals ({ticker})'</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">tight_layout</span><span class="python1-symbol">()
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">savefig</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'residuals_{ticker}.png'</span><span class="python1-symbol">)</span><span class="python1-space">  </span><span class="python1-comment"># Save plot for report
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-comment"># Calculate risk metrics (annualized)
</span><span class="python1-identifier">mean_returns</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">returns</span><span class="python1-symbol">.</span><span class="python1-identifier">mean</span><span class="python1-symbol">()</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-number">252</span><span class="python1-space">  </span><span class="python1-comment"># Annualized mean returns (252 trading days)
</span><span class="python1-identifier">std_dev</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">returns</span><span class="python1-symbol">.</span><span class="python1-identifier">std</span><span class="python1-symbol">()</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-identifier">np</span><span class="python1-symbol">.</span><span class="python1-identifier">sqrt</span><span class="python1-symbol">(</span><span class="python1-number">252</span><span class="python1-symbol">)</span><span class="python1-space">  </span><span class="python1-comment"># Annualized standard deviation
</span><span class="python1-identifier">sharpe_ratio</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">mean_returns</span><span class="python1-space"> </span><span class="python1-symbol">/</span><span class="python1-space"> </span><span class="python1-identifier">std_dev</span><span class="python1-space">  </span><span class="python1-comment"># Sharpe ratio (assuming risk-free rate = 0 for simplicity)

# Portfolio risk metrics
</span><span class="python1-identifier">portfolio_mean</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">mean</span><span class="python1-symbol">()</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-number">252
</span><span class="python1-identifier">portfolio_std</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_returns</span><span class="python1-symbol">.</span><span class="python1-identifier">std</span><span class="python1-symbol">()</span><span class="python1-space"> </span><span class="python1-symbol">*</span><span class="python1-space"> </span><span class="python1-identifier">np</span><span class="python1-symbol">.</span><span class="python1-identifier">sqrt</span><span class="python1-symbol">(</span><span class="python1-number">252</span><span class="python1-symbol">)
</span><span class="python1-identifier">portfolio_sharpe</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_mean</span><span class="python1-space"> </span><span class="python1-symbol">/</span><span class="python1-space"> </span><span class="python1-identifier">portfolio_std

</span><span class="python1-comment"># Print risk metrics
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-string">&quot;\nIndividual Stock Risk Metrics (Annualized):&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;{ticker} - Mean Return: {mean_returns[ticker]:.4f}, Std Dev: {std_dev[ticker]:.4f}, Sharpe Ratio: {sharpe_ratio[ticker]:.4f}&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nPortfolio Risk Metrics (Annualized):&quot;</span><span class="python1-symbol">)
</span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Mean Return: {portfolio_mean:.4f}, Std Dev: {portfolio_std:.4f}, Sharpe Ratio: {portfolio_sharpe:.4f}&quot;</span><span class="python1-symbol">)

</span><span class="python1-comment"># Plot risk metrics for visualization
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">6</span><span class="python1-symbol">))
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">bar</span><span class="python1-symbol">(</span><span class="python1-identifier">tickers</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-symbol">[</span><span class="python1-string">'Portfolio'</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">list</span><span class="python1-symbol">(</span><span class="python1-identifier">sharpe_ratio</span><span class="python1-symbol">.</span><span class="python1-identifier">values</span><span class="python1-symbol">)</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-symbol">[</span><span class="python1-identifier">portfolio_sharpe</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">color</span><span class="python1-symbol">=[</span><span class="python1-string">'blue'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'blue'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'blue'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'blue'</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-string">'green'</span><span class="python1-symbol">])
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-string">'Sharpe Ratios for Stocks and Portfolio'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">ylabel</span><span class="python1-symbol">(</span><span class="python1-string">'Sharpe Ratio'</span><span class="python1-symbol">)
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">savefig</span><span class="python1-symbol">(</span><span class="python1-string">'sharpe_ratios.png'</span><span class="python1-symbol">)</span><span class="python1-space">  </span><span class="python1-comment"># Save plot for report
</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">statsmodels</span><span class="python1-symbol">.</span><span class="python1-identifier">graphics</span><span class="python1-symbol">.</span><span class="python1-identifier">tsaplots</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">plot_acf</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">plot_pacf
</span><span class="python1-reservedword">from</span><span class="python1-space"> </span><span class="python1-identifier">itertools</span><span class="python1-space"> </span><span class="python1-reservedword">import</span><span class="python1-space"> </span><span class="python1-identifier">product

</span><span class="python1-reservedword">def</span><span class="python1-space"> </span><span class="python1-functionname">select_arima_order</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">stock_name</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_p</span><span class="python1-symbol">=</span><span class="python1-number">2</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_d</span><span class="python1-symbol">=</span><span class="python1-number">1</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_q</span><span class="python1-symbol">=</span><span class="python1-number">2</span><span class="python1-symbol">):
</span><span class="python1-space">    </span><span class="python1-documentation">&quot;&quot;&quot;Select best ARIMA order based on AIC.

    Args:
        series (pandas.Series): Time series to model.
        stock_name (str): Name of the stock.
        max_p (int): Maximum AR order.
        max_d (int): Maximum differencing order.
        max_q (int): Maximum MA order.

    Returns:
        tuple: Best (p, d, q) order.
    &quot;&quot;&quot;
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;\nSelecting ARIMA Order for {stock_name}:&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-comment"># Plot ACF/PACF to guide order selection
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">figure</span><span class="python1-symbol">(</span><span class="python1-identifier">figsize</span><span class="python1-symbol">=(</span><span class="python1-number">10</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-number">4</span><span class="python1-symbol">))
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">subplot</span><span class="python1-symbol">(</span><span class="python1-number">121</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plot_acf</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">lags</span><span class="python1-symbol">=</span><span class="python1-number">20</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">ax</span><span class="python1-symbol">=</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">())
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'ACF for {stock_name} Returns'</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">subplot</span><span class="python1-symbol">(</span><span class="python1-number">122</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plot_pacf</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">lags</span><span class="python1-symbol">=</span><span class="python1-number">20</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">ax</span><span class="python1-symbol">=</span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">gca</span><span class="python1-symbol">())
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">title</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'PACF for {stock_name} Returns'</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">tight_layout</span><span class="python1-symbol">()
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">savefig</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">'acf_pacf_{stock_name}.png'</span><span class="python1-symbol">)</span><span class="python1-space">  </span><span class="python1-comment"># Save plot for report
</span><span class="python1-space">    </span><span class="python1-identifier">plt</span><span class="python1-symbol">.</span><span class="python1-identifier">show</span><span class="python1-symbol">()

</span><span class="python1-space">    </span><span class="python1-comment"># Try different ARIMA orders
</span><span class="python1-space">    </span><span class="python1-identifier">p</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">range</span><span class="python1-symbol">(</span><span class="python1-number">0</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_p</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-number">1</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">d</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">range</span><span class="python1-symbol">(</span><span class="python1-number">0</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_d</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-number">1</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">q</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">range</span><span class="python1-symbol">(</span><span class="python1-number">0</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">max_q</span><span class="python1-space"> </span><span class="python1-symbol">+</span><span class="python1-space"> </span><span class="python1-number">1</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">pdq</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">list</span><span class="python1-symbol">(</span><span class="python1-identifier">product</span><span class="python1-symbol">(</span><span class="python1-identifier">p</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">d</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">q</span><span class="python1-symbol">))
</span><span class="python1-space">    </span><span class="python1-identifier">best_aic</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">float</span><span class="python1-symbol">(</span><span class="python1-string">'inf'</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-identifier">best_order</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-nonreservedkeyword">None
</span><span class="python1-space">    </span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">order</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">pdq</span><span class="python1-symbol">:
</span><span class="python1-space">        </span><span class="python1-reservedword">try</span><span class="python1-symbol">:
</span><span class="python1-space">            </span><span class="python1-identifier">model</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">ARIMA</span><span class="python1-symbol">(</span><span class="python1-identifier">series</span><span class="python1-symbol">,</span><span class="python1-space"> </span><span class="python1-identifier">order</span><span class="python1-symbol">=</span><span class="python1-identifier">order</span><span class="python1-symbol">)
</span><span class="python1-space">            </span><span class="python1-identifier">model_fit</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">model</span><span class="python1-symbol">.</span><span class="python1-identifier">fit</span><span class="python1-symbol">()
</span><span class="python1-space">            </span><span class="python1-reservedword">if</span><span class="python1-space"> </span><span class="python1-identifier">model_fit</span><span class="python1-symbol">.</span><span class="python1-identifier">aic</span><span class="python1-space"> </span><span class="python1-symbol">&lt;</span><span class="python1-space"> </span><span class="python1-identifier">best_aic</span><span class="python1-symbol">:
</span><span class="python1-space">                </span><span class="python1-identifier">best_aic</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">model_fit</span><span class="python1-symbol">.</span><span class="python1-identifier">aic
</span><span class="python1-space">                </span><span class="python1-identifier">best_order</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">order
</span><span class="python1-space">        </span><span class="python1-reservedword">except</span><span class="python1-symbol">:
</span><span class="python1-space">            </span><span class="python1-reservedword">continue
</span><span class="python1-space">    </span><span class="python1-reservedword">print</span><span class="python1-symbol">(</span><span class="python1-identifier">f</span><span class="python1-string">&quot;Best ARIMA order for {stock_name}: {best_order} (AIC: {best_aic:.2f})&quot;</span><span class="python1-symbol">)
</span><span class="python1-space">    </span><span class="python1-reservedword">return</span><span class="python1-space"> </span><span class="python1-identifier">best_order

</span><span class="python1-comment"># Select ARIMA order for each stock
</span><span class="python1-identifier">best_orders</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-symbol">{}
</span><span class="python1-reservedword">for</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-space"> </span><span class="python1-reservedword">in</span><span class="python1-space"> </span><span class="python1-identifier">tickers</span><span class="python1-symbol">:
</span><span class="python1-space">    </span><span class="python1-identifier">best_orders</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">]</span><span class="python1-space"> </span><span class="python1-symbol">=</span><span class="python1-space"> </span><span class="python1-identifier">select_arima_order</span><span class="python1-symbol">(</span><span class="python1-identifier">returns</span><span class="python1-symbol">[</span><span class="python1-identifier">ticker</span><span class="python1-symbol">],</span><span class="python1-space"> </span><span class="python1-identifier">ticker</span><span class="python1-symbol">)
</span></code></pre><!--EndFragment--></body>
</html>